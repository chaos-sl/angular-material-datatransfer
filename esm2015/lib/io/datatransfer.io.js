import { ConfigService } from '../services/config.service';
import { StreamHashContainer } from '../models/hash-container.model';
import { HashTypeImplementation, HashTypeExtensions } from '../enums/hash-type.enum';
import { EncodingTypeImplementation, EncodingTypeExtensions } from '../enums/encoding-type.enum';
export class BaseDatatransfer {
    constructor(logger, guidUtil, cryptoService) {
        this.logger = logger;
        this.guidUtil = guidUtil;
        this.cryptoService = cryptoService;
        this.events = [];
        this._isWorking = false;
    }
    on(event, callback) {
        this.events.push(event.toLowerCase(), callback);
    }
    fire(...args) {
        const event = args[0].toLowerCase();
        // Find event listeners, and support pseudo-event `catchAll`
        for (let i = 0; i <= this.events.length; i += 2) {
            if (this.events[i] === event) {
                this.events[i + 1].apply(this, args.slice(1));
            }
            if (this.events[i] === 'catchall') {
                this.events[i + 1].apply(null, args);
            }
        }
    }
    updateZone() {
        this.fire('zoneUpdated');
    }
    changeItemStatus(item, status, message) {
        this.fire('itemStatusChanged', item, status, message);
    }
    updateItemProgress(item, progress) {
        this.fire('itemProgressUpdated', item, progress);
    }
    updateOverallProgress(transferType, progress) {
        this.fire('overallProgressUpdated', transferType, progress);
    }
    updateOverallSize(size) {
        this.fire('overallSizeUpdated', size);
    }
    isWorking() {
        return this._isWorking;
    }
    addItem(item) {
        this.fire('itemAdded', item);
    }
    generateUniqueIdentifier() {
        return this.guidUtil.createGuid();
    }
    preprocessHash(item, file, continueCallback, cancelCallback) {
        const successCallback = function (container) {
            const that = this;
            if (container.hashString) {
                // const seconds = (container.endDate.getTime() - container.startDate.getTime()) / 1000;
                // console.log('file hashing took ' + seconds + ' seconds');
                const xhr = new XMLHttpRequest();
                const responseHandler = function (e) {
                    // ignore response if container has been cancelled
                    if (!container.isCancelled()) {
                        if (xhr.status === 200) {
                            item.message = xhr.responseText;
                            cancelCallback();
                        }
                        else {
                            continueCallback();
                        }
                    }
                };
                xhr.addEventListener('load', responseHandler, false);
                xhr.addEventListener('error', responseHandler, false);
                xhr.addEventListener('timeout', responseHandler, false);
                let params = [];
                params = params.concat([
                    [ConfigService.settings.core.preprocessHashParameterName, container.hashString],
                    [ConfigService.settings.core.preprocessHashFileNameParameterName, item.name]
                ]
                    .map(function (pair) {
                    return [
                        pair[0], encodeURIComponent(pair[1])
                    ].join('=');
                }));
                xhr.open(ConfigService.settings.core.preprocessHashMethod, ConfigService.settings.core.getTarget('preprocessHash', params));
                xhr.send(null);
            }
            else {
                continueCallback();
            }
        }.bind(this);
        const errorCallback = function (event, container) {
            console.log(event);
            continueCallback();
        };
        if (!item.preprocessContainer.isCancelled() && item.preprocessContainer instanceof StreamHashContainer) {
            // continue
        }
        else {
            const hashType = HashTypeExtensions.toEnum(HashTypeImplementation.Internal, ConfigService.settings.core.preprocessHashFunctionName);
            const encodingType = EncodingTypeExtensions.toEnum(EncodingTypeImplementation.Internal, ConfigService.settings.core.preprocessHashEncodingName);
            const inputEncodingType = EncodingTypeExtensions.toEnum(EncodingTypeImplementation.Internal, ConfigService.settings.core.preprocessHashInputEncodingName);
            item.preprocessContainer = this.cryptoService.createStreamHashContainer(file, hashType, encodingType, inputEncodingType, successCallback, errorCallback);
        }
        // wait for the initial mat-progress-spinner animation to complete
        setTimeout(function () {
            item.preprocessContainer.run();
        }, 1000);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXRyYW5zZmVyLmlvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW1kLWxpYi9zcmMvbGliL2lvL2RhdGF0cmFuc2Zlci5pby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFNM0QsT0FBTyxFQUF3QixtQkFBbUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzNGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBYWpHLE1BQU0sT0FBZ0IsZ0JBQWdCO0lBS2xDLFlBQXNCLE1BQXFCLEVBQ3JCLFFBQWtCLEVBQ2xCLGFBQTRCO1FBRjVCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUwxQyxXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1YsZUFBVSxHQUFHLEtBQUssQ0FBQztJQUs3QixDQUFDO0lBRU0sRUFBRSxDQUFDLEtBQWEsRUFBRSxRQUFrQjtRQUN2QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVTLElBQUksQ0FBQyxHQUFHLElBQVc7UUFDekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BDLDREQUE0RDtRQUM1RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM3QyxJQUFJLElBQUksQ0FBQyxN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RyxzQkFBc0IsQ0FBQyxNQUFNLENBQzlDLDBCQUEwQixDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1lBQ2pHLE1BQU0saUJBQWlCLEdBQUcsc0JBQXNCLENBQUMsTUFBTSxDQUNuRCwwQkFBMEIsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztZQUV0RyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsQ0FDbkUsSUFBSSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ3hGO1FBRUQsa0VBQWtFO1FBQ2xFLFVBQVUsQ0FBQztZQUNQLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNuQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDYixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJRGF0YXRyYW5zZmVySXRlbSB9IGZyb20gJy4uL21vZGVscy9kYXRhdHJhbnNmZXItaXRlbS5tb2RlbCc7XHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb25maWcuc2VydmljZSc7XHJcbmltcG9ydCB7IExvZ2dlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9sb2dnZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IEd1aWRVdGlsIH0gZnJvbSAnLi4vdXRpbHMvZ3VpZC51dGlsJztcclxuaW1wb3J0IHsgQ3J5cHRvU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2NyeXB0by5zZXJ2aWNlJztcclxuaW1wb3J0IHsgVHJhbnNmZXJTdGF0dXMgfSBmcm9tICcuLi9lbnVtcy90cmFuc2Zlci1zdGF0dXMuZW51bSc7XHJcbmltcG9ydCB7IFRyYW5zZmVyVHlwZSB9IGZyb20gJy4uL2VudW1zL3RyYW5zZmVyLXR5cGUuZW51bSc7XHJcbmltcG9ydCB7IElTdHJlYW1IYXNoQ29udGFpbmVyLCBTdHJlYW1IYXNoQ29udGFpbmVyIH0gZnJvbSAnLi4vbW9kZWxzL2hhc2gtY29udGFpbmVyLm1vZGVsJztcclxuaW1wb3J0IHsgSGFzaFR5cGVJbXBsZW1lbnRhdGlvbiwgSGFzaFR5cGVFeHRlbnNpb25zIH0gZnJvbSAnLi4vZW51bXMvaGFzaC10eXBlLmVudW0nO1xyXG5pbXBvcnQgeyBFbmNvZGluZ1R5cGVJbXBsZW1lbnRhdGlvbiwgRW5jb2RpbmdUeXBlRXh0ZW5zaW9ucyB9IGZyb20gJy4uL2VudW1zL2VuY29kaW5nLXR5cGUuZW51bSc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElEYXRhdHJhbnNmZXIge1xyXG4gICAgb24oZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZDtcclxuICAgIGlzV29ya2luZygpOiBib29sZWFuO1xyXG4gICAgc3RhcnRBbGwoKTogdm9pZDtcclxuICAgIHBhdXNlQWxsKCk6IHZvaWQ7XHJcbiAgICByZW1vdmVBbGwoKTogdm9pZDtcclxuICAgIGFkZEl0ZW0oaXRlbTogSURhdGF0cmFuc2Zlckl0ZW0pOiB2b2lkO1xyXG4gICAgcmVtb3ZlSXRlbShpdGVtOiBJRGF0YXRyYW5zZmVySXRlbSk6IHZvaWQ7XHJcbiAgICByZXRyeUl0ZW0oaXRlbTogSURhdGF0cmFuc2Zlckl0ZW0pOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZURhdGF0cmFuc2ZlciBpbXBsZW1lbnRzIElEYXRhdHJhbnNmZXIge1xyXG5cclxuICAgIHByaXZhdGUgZXZlbnRzID0gW107XHJcbiAgICBwcm90ZWN0ZWQgX2lzV29ya2luZyA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBsb2dnZXI6IExvZ2dlclNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgZ3VpZFV0aWw6IEd1aWRVdGlsLFxyXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIGNyeXB0b1NlcnZpY2U6IENyeXB0b1NlcnZpY2UpIHtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb24oZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5ldmVudHMucHVzaChldmVudC50b0xvd2VyQ2FzZSgpLCBjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGZpcmUoLi4uYXJnczogYW55W10pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBldmVudCA9IGFyZ3NbMF0udG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAvLyBGaW5kIGV2ZW50IGxpc3RlbmVycywgYW5kIHN1cHBvcnQgcHNldWRvLWV2ZW50IGBjYXRjaEFsbGBcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB0aGlzLmV2ZW50cy5sZW5ndGg7IGkgKz0gMikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5ldmVudHNbaV0gPT09IGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50c1tpICsgMV0uYXBwbHkodGhpcywgYXJncy5zbGljZSgxKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuZXZlbnRzW2ldID09PSAnY2F0Y2hhbGwnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50c1tpICsgMV0uYXBwbHkobnVsbCwgYXJncyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVpvbmUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5maXJlKCd6b25lVXBkYXRlZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjaGFuZ2VJdGVtU3RhdHVzKGl0ZW06IElEYXRhdHJhbnNmZXJJdGVtLCBzdGF0dXM6IFRyYW5zZmVyU3RhdHVzLCBtZXNzYWdlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5maXJlKCdpdGVtU3RhdHVzQ2hhbmdlZCcsIGl0ZW0sIHN0YXR1cywgbWVzc2FnZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZUl0ZW1Qcm9ncmVzcyhpdGVtOiBJRGF0YXRyYW5zZmVySXRlbSwgcHJvZ3Jlc3M6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlyZSgnaXRlbVByb2dyZXNzVXBkYXRlZCcsIGl0ZW0sIHByb2dyZXNzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgdXBkYXRlT3ZlcmFsbFByb2dyZXNzKHRyYW5zZmVyVHlwZTogVHJhbnNmZXJUeXBlLCBwcm9ncmVzczogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5maXJlKCdvdmVyYWxsUHJvZ3Jlc3NVcGRhdGVkJywgdHJhbnNmZXJUeXBlLCBwcm9ncmVzcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZU92ZXJhbGxTaXplKHNpemU6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlyZSgnb3ZlcmFsbFNpemVVcGRhdGVkJywgc2l6ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzV29ya2luZygpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXNXb3JraW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhYnN0cmFjdCBzdGFydEFsbCgpOiB2b2lkO1xyXG5cclxuICAgIHB1YmxpYyBhYnN0cmFjdCBwYXVzZUFsbCgpOiB2b2lkO1xyXG5cclxuICAgIHB1YmxpYyBhYnN0cmFjdCByZW1vdmVBbGwoKTogdm9pZDtcclxuXHJcbiAgICBwdWJsaWMgYWRkSXRlbShpdGVtOiBJRGF0YXRyYW5zZmVySXRlbSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlyZSgnaXRlbUFkZGVkJywgaXRlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFic3RyYWN0IHJlbW92ZUl0ZW0oaXRlbTogSURhdGF0cmFuc2Zlckl0ZW0pOiB2b2lkO1xyXG5cclxuICAgIHB1YmxpYyBhYnN0cmFjdCByZXRyeUl0ZW0oaXRlbTogSURhdGF0cmFuc2Zlckl0ZW0pOiB2b2lkO1xyXG5cclxuICAgIHByb3RlY3RlZCBnZW5lcmF0ZVVuaXF1ZUlkZW50aWZpZXIoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ndWlkVXRpbC5jcmVhdGVHdWlkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHByZXByb2Nlc3NIYXNoKGl0ZW06IElEYXRhdHJhbnNmZXJJdGVtLCBmaWxlOiBGaWxlLCBjb250aW51ZUNhbGxiYWNrOiBGdW5jdGlvbiwgY2FuY2VsQ2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgc3VjY2Vzc0NhbGxiYWNrID0gZnVuY3Rpb24oY29udGFpbmVyOiBJU3RyZWFtSGFzaENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBjb25zdCB0aGF0ID0gdGhpcyBhcyBCYXNlRGF0YXRyYW5zZmVyO1xyXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc2hTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnN0IHNlY29uZHMgPSAoY29udGFpbmVyLmVuZERhdGUuZ2V0VGltZSgpIC0gY29udGFpbmVyLnN0YXJ0RGF0ZS5nZXRUaW1lKCkpIC8gMTAwMDtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdmaWxlIGhhc2hpbmcgdG9vayAnICsgc2Vjb25kcyArICcgc2Vjb25kcycpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgcmVzcG9uc2UgaWYgY29udGFpbmVyIGhhcyBiZWVuIGNhbmNlbGxlZFxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghY29udGFpbmVyLmlzQ2FuY2VsbGVkKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5tZXNzYWdlID0geGhyLnJlc3BvbnNlVGV4dDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZUNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCByZXNwb25zZUhhbmRsZXIsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIHJlc3BvbnNlSGFuZGxlciwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWVvdXQnLCByZXNwb25zZUhhbmRsZXIsIGZhbHNlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFyYW1zID0gW107XHJcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMuY29uY2F0KFxyXG4gICAgICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgW0NvbmZpZ1NlcnZpY2Uuc2V0dGluZ3MuY29yZS5wcmVwcm9jZXNzSGFzaFBhcmFtZXRlck5hbWUsIGNvbnRhaW5lci5oYXNoU3RyaW5nXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgW0NvbmZpZ1NlcnZpY2Uuc2V0dGluZ3MuY29yZS5wcmVwcm9jZXNzSGFzaEZpbGVOYW1lUGFyYW1ldGVyTmFtZSwgaXRlbS5uYW1lXVxyXG4gICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbihwYWlyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhaXJbMF0sIGVuY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCc9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgIHhoci5vcGVuKENvbmZpZ1NlcnZpY2Uuc2V0dGluZ3MuY29yZS5wcmVwcm9jZXNzSGFzaE1ldGhvZCwgQ29uZmlnU2VydmljZS5zZXR0aW5ncy5jb3JlLmdldFRhcmdldCgncHJlcHJvY2Vzc0hhc2gnLCBwYXJhbXMpKTtcclxuICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlQ2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0uYmluZCh0aGlzKTtcclxuICAgICAgICBjb25zdCBlcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oZXZlbnQ6IGFueSwgY29udGFpbmVyOiBJU3RyZWFtSGFzaENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldmVudCk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlQ2FsbGJhY2soKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAoIWl0ZW0ucHJlcHJvY2Vzc0NvbnRhaW5lci5pc0NhbmNlbGxlZCgpICYmIGl0ZW0ucHJlcHJvY2Vzc0NvbnRhaW5lciBpbnN0YW5jZW9mIFN0cmVhbUhhc2hDb250YWluZXIpIHtcclxuICAgICAgICAgICAgLy8gY29udGludWVcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBoYXNoVHlwZSA9IEhhc2hUeXBlRXh0ZW5zaW9ucy50b0VudW0oXHJcbiAgICAgICAgICAgICAgICBIYXNoVHlwZUltcGxlbWVudGF0aW9uLkludGVybmFsLCBDb25maWdTZXJ2aWNlLnNldHRpbmdzLmNvcmUucHJlcHJvY2Vzc0hhc2hGdW5jdGlvbk5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBlbmNvZGluZ1R5cGUgPSBFbmNvZGluZ1R5cGVFeHRlbnNpb25zLnRvRW51bShcclxuICAgICAgICAgICAgICAgIEVuY29kaW5nVHlwZUltcGxlbWVudGF0aW9uLkludGVybmFsLCBDb25maWdTZXJ2aWNlLnNldHRpbmdzLmNvcmUucHJlcHJvY2Vzc0hhc2hFbmNvZGluZ05hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dEVuY29kaW5nVHlwZSA9IEVuY29kaW5nVHlwZUV4dGVuc2lvbnMudG9FbnVtKFxyXG4gICAgICAgICAgICAgICAgRW5jb2RpbmdUeXBlSW1wbGVtZW50YXRpb24uSW50ZXJuYWwsIENvbmZpZ1NlcnZpY2Uuc2V0dGluZ3MuY29yZS5wcmVwcm9jZXNzSGFzaElucHV0RW5jb2RpbmdOYW1lKTtcclxuXHJcbiAgICAgICAgICAgIGl0ZW0ucHJlcHJvY2Vzc0NvbnRhaW5lciA9IHRoaXMuY3J5cHRvU2VydmljZS5jcmVhdGVTdHJlYW1IYXNoQ29udGFpbmVyKFxyXG4gICAgICAgICAgICAgICAgZmlsZSwgaGFzaFR5cGUsIGVuY29kaW5nVHlwZSwgaW5wdXRFbmNvZGluZ1R5cGUsIHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB3YWl0IGZvciB0aGUgaW5pdGlhbCBtYXQtcHJvZ3Jlc3Mtc3Bpbm5lciBhbmltYXRpb24gdG8gY29tcGxldGVcclxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBpdGVtLnByZXByb2Nlc3NDb250YWluZXIucnVuKCk7XHJcbiAgICAgICAgfSwgMTAwMCk7XHJcbiAgICB9XHJcbn1cclxuIl19