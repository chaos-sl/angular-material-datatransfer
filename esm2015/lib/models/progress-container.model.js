import { ReflectiveInjector } from '@angular/core';
import { DateUtil } from '../utils/date.util';
import { SizeContainer } from './size-container.model';
import { DecimalByteUnit } from '../enums/decimal-byte-unit.enum';
export class ProgressContainer {
    constructor(total) {
        const injector = ReflectiveInjector.resolveAndCreate([DateUtil]);
        this.dateUtil = injector.get(DateUtil);
        this.bitrateSizeContainer = new SizeContainer();
        this.loadedSizeContainer = new SizeContainer();
        this.totalSizeContainer = new SizeContainer();
        this.reset(total);
    }
    reset(total) {
        this.progressTimestamp = this.dateUtil.now();
        this.bitrateTimestamp = this.dateUtil.now();
        this.loaded = 0;
        this.bitrate = 0;
        this.percent = 0;
        this.total = total;
        this.displayBitrate = undefined;
        this.displayTimeLeft = undefined;
        this.bitrateSizeContainer.updateDecimal(DecimalByteUnit.Byte, this.bitrate);
        this.loadedSizeContainer.updateDecimal(DecimalByteUnit.Byte, this.loaded);
        this.totalSizeContainer.updateDecimal(DecimalByteUnit.Byte, this.total);
    }
    updateProgress(now, loaded, interval) {
        const timeDiff = now - this.progressTimestamp;
        // console.log('loaded: ' + loaded + ' total: ' + this.total);
        if (!this.percent || timeDiff > interval) {
            this.percent = Number((loaded / this.total * 100).toFixed(2));
            this.loaded = loaded;
            this.loadedSizeContainer.updateDecimal(DecimalByteUnit.Byte, this.loaded);
            this.progressTimestamp = now;
            if (this.bitrate > 0) {
                this.displayTimeLeft = this.dateUtil.format((this.total - this.loaded) * 8 / this.bitrate);
            }
            else {
                this.displayTimeLeft = this.dateUtil.format(0);
            }
        }
        else if (loaded >= this.total) {
            this.percent = 100;
            this.loaded = this.total;
        }
    }
    updateBitrate(now, loaded, interval) {
        const timeDiff = now - this.bitrateTimestamp;
        if (!this.bitrate || timeDiff > interval) {
            this.bitrate = (loaded - this.loaded) * (1000 / timeDiff) * 8;
            if (this.bitrate === Number.POSITIVE_INFINITY || this.bitrate === Number.NEGATIVE_INFINITY) {
                this.bitrate = 0;
            }
            this.bitrateSizeContainer.updateDecimal(DecimalByteUnit.Byte, this.bitrate / 8);
            this.displayBitrate = this.bitrateSizeContainer.displaySize + ' ' + this.bitrateSizeContainer.displayUnit + '/s';
            this.bitrateTimestamp = now;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3MtY29udGFpbmVyLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW1kLWxpYi9zcmMvbGliL21vZGVscy9wcm9ncmVzcy1jb250YWluZXIubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQWtCLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQWlCbEUsTUFBTSxPQUFPLGlCQUFpQjtJQWUxQixZQUFtQixLQUFhO1FBQzVCLE1BQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFdkMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7UUFDaEQsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7UUFDL0MsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7UUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQWE7UUFDdEIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDN0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7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QUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFDakgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEdBQUcsQ0FBQztTQUMvQjtJQUNMLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlZmxlY3RpdmVJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRlVXRpbCB9IGZyb20gJy4uL3V0aWxzL2RhdGUudXRpbCc7XHJcbmltcG9ydCB7IElTaXplQ29udGFpbmVyLCBTaXplQ29udGFpbmVyIH0gZnJvbSAnLi9zaXplLWNvbnRhaW5lci5tb2RlbCc7XHJcbmltcG9ydCB7IERlY2ltYWxCeXRlVW5pdCB9IGZyb20gJy4uL2VudW1zL2RlY2ltYWwtYnl0ZS11bml0LmVudW0nO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJUHJvZ3Jlc3NDb250YWluZXIge1xyXG4gICAgdG90YWw6IG51bWJlcjsgLy8gYnl0ZXNcclxuICAgIHByb2dyZXNzVGltZXN0YW1wOiBudW1iZXI7IC8vIG1pbGxpc2Vjb25kc1xyXG4gICAgYml0cmF0ZVRpbWVzdGFtcDogbnVtYmVyOyAvLyBtaWxsaXNlY29uZHNcclxuICAgIGJpdHJhdGU6IG51bWJlcjsgLy8gYml0L3NcclxuICAgIHBlcmNlbnQ6IG51bWJlcjsgLy8gMC0xMDBcclxuICAgIGRpc3BsYXlCaXRyYXRlOiBzdHJpbmc7XHJcbiAgICBkaXNwbGF5VGltZUxlZnQ6IHN0cmluZztcclxuICAgIGxvYWRlZFNpemVDb250YWluZXI6IElTaXplQ29udGFpbmVyO1xyXG4gICAgdG90YWxTaXplQ29udGFpbmVyOiBJU2l6ZUNvbnRhaW5lcjtcclxuICAgIHJlc2V0KHRvdGFsOiBudW1iZXIpOiB2b2lkO1xyXG4gICAgdXBkYXRlUHJvZ3Jlc3Mobm93OiBudW1iZXIsIGxvYWRlZDogbnVtYmVyLCBpbnRlcnZhbDogbnVtYmVyKTogdm9pZDtcclxuICAgIHVwZGF0ZUJpdHJhdGUobm93OiBudW1iZXIsIGxvYWRlZDogbnVtYmVyLCBpbnRlcnZhbDogbnVtYmVyKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFByb2dyZXNzQ29udGFpbmVyIGltcGxlbWVudHMgSVByb2dyZXNzQ29udGFpbmVyIHtcclxuICAgIHByaXZhdGUgZGF0ZVV0aWw6IERhdGVVdGlsO1xyXG4gICAgcHJpdmF0ZSBsb2FkZWQ6IG51bWJlcjsgLy8gYnl0ZXNcclxuICAgIHByaXZhdGUgYml0cmF0ZVNpemVDb250YWluZXI6IElTaXplQ29udGFpbmVyO1xyXG5cclxuICAgIHB1YmxpYyB0b3RhbDogbnVtYmVyO1xyXG4gICAgcHVibGljIHByb2dyZXNzVGltZXN0YW1wOiBudW1iZXI7XHJcbiAgICBwdWJsaWMgYml0cmF0ZVRpbWVzdGFtcDogbnVtYmVyO1xyXG4gICAgcHVibGljIGJpdHJhdGU6IG51bWJlcjtcclxuICAgIHB1YmxpYyBwZXJjZW50OiBudW1iZXI7XHJcbiAgICBwdWJsaWMgZGlzcGxheUJpdHJhdGU6IHN0cmluZztcclxuICAgIHB1YmxpYyBkaXNwbGF5VGltZUxlZnQ6IHN0cmluZztcclxuICAgIHB1YmxpYyBsb2FkZWRTaXplQ29udGFpbmVyOiBJU2l6ZUNvbnRhaW5lcjtcclxuICAgIHB1YmxpYyB0b3RhbFNpemVDb250YWluZXI6IElTaXplQ29udGFpbmVyO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcih0b3RhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZUFuZENyZWF0ZShbRGF0ZVV0aWxdKTtcclxuICAgICAgICB0aGlzLmRhdGVVdGlsID0gaW5qZWN0b3IuZ2V0KERhdGVVdGlsKTtcclxuXHJcbiAgICAgICAgdGhpcy5iaXRyYXRlU2l6ZUNvbnRhaW5lciA9IG5ldyBTaXplQ29udGFpbmVyKCk7XHJcbiAgICAgICAgdGhpcy5sb2FkZWRTaXplQ29udGFpbmVyID0gbmV3IFNpemVDb250YWluZXIoKTtcclxuICAgICAgICB0aGlzLnRvdGFsU2l6ZUNvbnRhaW5lciA9IG5ldyBTaXplQ29udGFpbmVyKCk7XHJcbiAgICAgICAgdGhpcy5yZXNldCh0b3RhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlc2V0KHRvdGFsOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnByb2dyZXNzVGltZXN0YW1wID0gdGhpcy5kYXRlVXRpbC5ub3coKTtcclxuICAgICAgICB0aGlzLmJpdHJhdGVUaW1lc3RhbXAgPSB0aGlzLmRhdGVVdGlsLm5vdygpO1xyXG4gICAgICAgIHRoaXMubG9hZGVkID0gMDtcclxuICAgICAgICB0aGlzLmJpdHJhdGUgPSAwO1xyXG4gICAgICAgIHRoaXMucGVyY2VudCA9IDA7XHJcbiAgICAgICAgdGhpcy50b3RhbCA9IHRvdGFsO1xyXG4gICAgICAgIHRoaXMuZGlzcGxheUJpdHJhdGUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5kaXNwbGF5VGltZUxlZnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5iaXRyYXRlU2l6ZUNvbnRhaW5lci51cGRhdGVEZWNpbWFsKERlY2ltYWxCeXRlVW5pdC5CeXRlLCB0aGlzLmJpdHJhdGUpO1xyXG4gICAgICAgIHRoaXMubG9hZGVkU2l6ZUNvbnRhaW5lci51cGRhdGVEZWNpbWFsKERlY2ltYWxCeXRlVW5pdC5CeXRlLCB0aGlzLmxvYWRlZCk7XHJcbiAgICAgICAgdGhpcy50b3RhbFNpemVDb250YWluZXIudXBkYXRlRGVjaW1hbChEZWNpbWFsQnl0ZVVuaXQuQnl0ZSwgdGhpcy50b3RhbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVwZGF0ZVByb2dyZXNzKG5vdzogbnVtYmVyLCBsb2FkZWQ6IG51bWJlciwgaW50ZXJ2YWw6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IHRpbWVEaWZmID0gbm93IC0gdGhpcy5wcm9ncmVzc1RpbWVzdGFtcDtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygnbG9hZGVkOiAnICsgbG9hZGVkICsgJyB0b3RhbDogJyArIHRoaXMudG90YWwpO1xyXG4gICAgICAgIGlmICghdGhpcy5wZXJjZW50IHx8IHRpbWVEaWZmID4gaW50ZXJ2YWwpIHtcclxuICAgICAgICAgICAgdGhpcy5wZXJjZW50ID0gTnVtYmVyKChsb2FkZWQgLyB0aGlzLnRvdGFsICogMTAwKS50b0ZpeGVkKDIpKTtcclxuICAgICAgICAgICAgdGhpcy5sb2FkZWQgPSBsb2FkZWQ7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZGVkU2l6ZUNvbnRhaW5lci51cGRhdGVEZWNpbWFsKERlY2ltYWxCeXRlVW5pdC5CeXRlLCB0aGlzLmxvYWRlZCk7XHJcbiAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3NUaW1lc3RhbXAgPSBub3c7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJpdHJhdGUgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlUaW1lTGVmdCA9IHRoaXMuZGF0ZVV0aWwuZm9ybWF0KCh0aGlzLnRvdGFsIC0gdGhpcy5sb2FkZWQpICogOCAvIHRoaXMuYml0cmF0ZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlUaW1lTGVmdCA9IHRoaXMuZGF0ZVV0aWwuZm9ybWF0KDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChsb2FkZWQgPj0gdGhpcy50b3RhbCkge1xyXG4gICAgICAgICAgICB0aGlzLnBlcmNlbnQgPSAxMDA7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZGVkID0gdGhpcy50b3RhbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVwZGF0ZUJpdHJhdGUobm93OiBudW1iZXIsIGxvYWRlZDogbnVtYmVyLCBpbnRlcnZhbDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgdGltZURpZmYgPSBub3cgLSB0aGlzLmJpdHJhdGVUaW1lc3RhbXA7XHJcbiAgICAgICAgaWYgKCF0aGlzLmJpdHJhdGUgfHwgdGltZURpZmYgPiBpbnRlcnZhbCkge1xyXG4gICAgICAgICAgICB0aGlzLmJpdHJhdGUgPSAobG9hZGVkIC0gdGhpcy5sb2FkZWQpICogKDEwMDAgLyB0aW1lRGlmZikgKiA4O1xyXG4gICAgICAgICAgICBpZiAodGhpcy5iaXRyYXRlID09PSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkgfHwgdGhpcy5iaXRyYXRlID09PSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYml0cmF0ZSA9IDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5iaXRyYXRlU2l6ZUNvbnRhaW5lci51cGRhdGVEZWNpbWFsKERlY2ltYWxCeXRlVW5pdC5CeXRlLCB0aGlzLmJpdHJhdGUgLyA4KTtcclxuICAgICAgICAgICAgdGhpcy5kaXNwbGF5Qml0cmF0ZSA9IHRoaXMuYml0cmF0ZVNpemVDb250YWluZXIuZGlzcGxheVNpemUgKyAnICcgKyB0aGlzLmJpdHJhdGVTaXplQ29udGFpbmVyLmRpc3BsYXlVbml0ICsgJy9zJztcclxuICAgICAgICAgICAgdGhpcy5iaXRyYXRlVGltZXN0YW1wID0gbm93O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=